<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility & Keyboard Navigation E2E Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        .test-result {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        /* High contrast mode simulation */
        .high-contrast {
            background: #000;
            color: #fff;
        }
        .high-contrast button {
            background: #fff;
            color: #000;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>
    <h1>Accessibility & Keyboard Navigation E2E Tests</h1>
    <p>This test suite validates accessibility features and keyboard navigation functionality.</p>

    <div class="test-section">
        <h2>Keyboard Navigation Tests</h2>
        <button onclick="runKeyboardTests()" id="keyboard-test-btn">Run Keyboard Tests</button>
        <div id="keyboard-results"></div>
    </div>

    <div class="test-section">
        <h2>Screen Reader Support Tests</h2>
        <button onclick="runScreenReaderTests()" id="screen-reader-test-btn">Run Screen Reader Tests</button>
        <div id="screen-reader-results"></div>
    </div>

    <div class="test-section">
        <h2>High Contrast Mode Tests</h2>
        <button onclick="runHighContrastTests()" id="high-contrast-test-btn">Run High Contrast Tests</button>
        <div id="high-contrast-results"></div>
    </div>

    <div class="test-section">
        <h2>Focus Management Tests</h2>
        <button onclick="runFocusTests()" id="focus-test-btn">Run Focus Tests</button>
        <div id="focus-results"></div>
    </div>

    <div class="test-section">
        <h2>ARIA Support Tests</h2>
        <button onclick="runAriaTests()" id="aria-test-btn">Run ARIA Tests</button>
        <div id="aria-results"></div>
    </div>

    <!-- Load required modules -->
    <script src="../public/assets/js/utils.js"></script>
    <script src="../public/assets/js/auth.js"></script>
    <script src="../public/assets/js/tickets.js"></script>

    <script>
        // Test framework
        class AccessibilityTestRunner {
            constructor() {
                this.results = [];
                this.currentSuite = '';
                this.totalTests = 0;
                this.passedTests = 0;
                this.failedTests = 0;
            }

            describe(suiteName, testFn) {
                this.currentSuite = suiteName;
                console.log(`\n=== ${suiteName} ===`);
                return testFn();
            }

            async it(testName, testFn) {
                this.totalTests++;
                try {
                    await testFn();
                    this.results.push({ suite: this.currentSuite, name: testName, status: 'pass' });
                    this.passedTests++;
                    this.logResult(this.currentSuite.toLowerCase().replace(/\s+/g, '-'), `✓ ${testName}`, 'pass');
                } catch (error) {
                    this.results.push({ 
                        suite: this.currentSuite, 
                        name: testName, 
                        status: 'fail', 
                        error: error.message 
                    });
                    this.failedTests++;
                    this.logResult(this.currentSuite.toLowerCase().replace(/\s+/g, '-'), `✗ ${testName}: ${error.message}`, 'fail');
                }
            }

            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual !== expected) {
                            throw new Error(`Expected ${expected}, but got ${actual}`);
                        }
                    },
                    toBeTruthy: () => {
                        if (!actual) {
                            throw new Error(`Expected truthy value, but got ${actual}`);
                        }
                    },
                    toBeFalsy: () => {
                        if (actual) {
                            throw new Error(`Expected falsy value, but got ${actual}`);
                        }
                    },
                    toContain: (expected) => {
                        if (typeof actual === 'string' && !actual.includes(expected)) {
                            throw new Error(`Expected "${actual}" to contain "${expected}"`);
                        }
                    }
                };
            }

            logResult(containerId, message, type = 'info') {
                const container = document.getElementById(`${containerId}-results`);
                if (!container) return;
                
                const result = document.createElement('div');
                result.className = `test-result ${type}`;
                result.textContent = message;
                container.appendChild(result);
            }

            clearResults(containerId) {
                const container = document.getElementById(`${containerId}-results`);
                if (container) {
                    container.innerHTML = '';
                }
            }

            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        const testRunner = new AccessibilityTestRunner();

        // Setup test environment
        function setupTestEnvironment() {
            localStorage.clear();
            sessionStorage.clear();
        }

        // Keyboard Navigation Tests
        async function runKeyboardTests() {
            testRunner.clearResults('keyboard-navigation');
            document.getElementById('keyboard-test-btn').disabled = true;
            
            await testRunner.describe('Keyboard Navigation', async () => {
                setupTestEnvironment();

                await testRunner.it('should support Enter key for form submission', async () => {
                    const authManager = new AuthManager();
                    
                    // Simulate Enter key press
                    const enterEvent = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        bubbles: true
                    });
                    
                    testRunner.expect(enterEvent.key).toBe('Enter');
                    
                    // Test login with Enter key simulation
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    testRunner.expect(result.success).toBeTruthy();
                });

                await testRunner.it('should support Tab navigation', async () => {
                    // Simulate Tab key navigation
                    const tabEvent = new KeyboardEvent('keydown', {
                        key: 'Tab',
                        code: 'Tab',
                        keyCode: 9,
                        bubbles: true
                    });
                    
                    testRunner.expect(tabEvent.key).toBe('Tab');
                    
                    // Test that modules work with keyboard navigation
                    const ticketManager = new TicketManager();
                    testRunner.expect(ticketManager).toBeTruthy();
                });

                await testRunner.it('should support Escape key for cancellation', async () => {
                    const escapeEvent = new KeyboardEvent('keydown', {
                        key: 'Escape',
                        code: 'Escape',
                        keyCode: 27,
                        bubbles: true
                    });
                    
                    testRunner.expect(escapeEvent.key).toBe('Escape');
                    
                    // Test that system handles escape gracefully
                    const authManager = new AuthManager();
                    testRunner.expect(authManager).toBeTruthy();
                });

                await testRunner.it('should support Arrow keys for navigation', async () => {
                    const arrowEvents = [
                        new KeyboardEvent('keydown', { key: 'ArrowUp', code: 'ArrowUp', keyCode: 38 }),
                        new KeyboardEvent('keydown', { key: 'ArrowDown', code: 'ArrowDown', keyCode: 40 }),
                        new KeyboardEvent('keydown', { key: 'ArrowLeft', code: 'ArrowLeft', keyCode: 37 }),
                        new KeyboardEvent('keydown', { key: 'ArrowRight', code: 'ArrowRight', keyCode: 39 })
                    ];
                    
                    arrowEvents.forEach(event => {
                        testRunner.expect(event.key).toContain('Arrow');
                    });
                    
                    // Test that system works with arrow key navigation
                    const ticketManager = new TicketManager();
                    const tickets = ticketManager.getTickets();
                    testRunner.expect(Array.isArray(tickets)).toBeTruthy();
                });

                await testRunner.it('should support Space key for activation', async () => {
                    const spaceEvent = new KeyboardEvent('keydown', {
                        key: ' ',
                        code: 'Space',
                        keyCode: 32,
                        bubbles: true
                    });
                    
                    testRunner.expect(spaceEvent.key).toBe(' ');
                    
                    // Test that space key works for interactions
                    const authManager = new AuthManager();
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    testRunner.expect(result.success).toBeTruthy();
                });
            });

            document.getElementById('keyboard-test-btn').disabled = false;
        }

        // Screen Reader Support Tests
        async function runScreenReaderTests() {
            testRunner.clearResults('screen-reader-support');
            document.getElementById('screen-reader-test-btn').disabled = true;
            
            await testRunner.describe('Screen Reader Support', async () => {
                setupTestEnvironment();

                await testRunner.it('should provide meaningful text content', async () => {
                    const authManager = new AuthManager();
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.user).toBeTruthy();
                    testRunner.expect(result.user.username).toBe('demo');
                    
                    // Screen readers should get meaningful feedback
                    testRunner.expect(typeof result.user.username).toBe('string');
                });

                await testRunner.it('should provide error messages for screen readers', async () => {
                    const authManager = new AuthManager();
                    const result = await authManager.login({ username: 'invalid', password: 'wrong' });
                    
                    testRunner.expect(result.success).toBeFalsy();
                    testRunner.expect(result.error).toBeTruthy();
                    testRunner.expect(typeof result.error).toBe('string');
                    testRunner.expect(result.error.length).toBeGreaterThan(0);
                });

                await testRunner.it('should provide status updates for screen readers', async () => {
                    const ticketManager = new TicketManager();
                    const result = await ticketManager.createTicket({
                        title: 'Screen Reader Test',
                        description: 'Testing screen reader support',
                        status: 'Open'
                    });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.ticket).toBeTruthy();
                    testRunner.expect(result.ticket.title).toBe('Screen Reader Test');
                });

                await testRunner.it('should provide semantic structure', async () => {
                    // Test that data structures are semantic and meaningful
                    const authManager = new AuthManager();
                    await authManager.login({ username: 'demo', password: 'password' });
                    
                    const session = authManager.getSession();
                    testRunner.expect(session).toBeTruthy();
                    testRunner.expect(session.user).toBeTruthy();
                    testRunner.expect(session.user.username).toBeTruthy();
                });
            });

            document.getElementById('screen-reader-test-btn').disabled = false;
        }

        // High Contrast Mode Tests
        async function runHighContrastTests() {
            testRunner.clearResults('high-contrast-mode');
            document.getElementById('high-contrast-test-btn').disabled = true;
            
            await testRunner.describe('High Contrast Mode', async () => {
                setupTestEnvironment();

                await testRunner.it('should work in high contrast mode', async () => {
                    // Simulate high contrast mode
                    document.body.classList.add('high-contrast');
                    
                    const authManager = new AuthManager();
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.user).toBeTruthy();
                    
                    // Remove high contrast class
                    document.body.classList.remove('high-contrast');
                });

                await testRunner.it('should maintain functionality in high contrast', async () => {
                    document.body.classList.add('high-contrast');
                    
                    const ticketManager = new TicketManager();
                    const result = await ticketManager.createTicket({
                        title: 'High Contrast Test',
                        description: 'Testing high contrast mode',
                        status: 'Open'
                    });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.ticket.title).toBe('High Contrast Test');
                    
                    document.body.classList.remove('high-contrast');
                });

                await testRunner.it('should handle color-based information alternatives', async () => {
                    // Test that system doesn't rely solely on color
                    const ticketManager = new TicketManager();
                    
                    // Create tickets with different statuses
                    await ticketManager.createTicket({ title: 'Open Ticket', description: 'Test', status: 'Open' });
                    await ticketManager.createTicket({ title: 'Progress Ticket', description: 'Test', status: 'In Progress' });
                    await ticketManager.createTicket({ title: 'Closed Ticket', description: 'Test', status: 'Closed' });
                    
                    const stats = ticketManager.getTicketStats();
                    
                    // Status information should be available as text, not just color
                    testRunner.expect(typeof stats.open).toBe('number');
                    testRunner.expect(typeof stats.inProgress).toBe('number');
                    testRunner.expect(typeof stats.closed).toBe('number');
                });
            });

            document.getElementById('high-contrast-test-btn').disabled = false;
        }

        // Focus Management Tests
        async function runFocusTests() {
            testRunner.clearResults('focus-management');
            document.getElementById('focus-test-btn').disabled = true;
            
            await testRunner.describe('Focus Management', async () => {
                setupTestEnvironment();

                await testRunner.it('should manage focus during authentication', async () => {
                    const authManager = new AuthManager();
                    
                    // Test focus management during login
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    testRunner.expect(result.success).toBeTruthy();
                    
                    // Focus should be manageable
                    testRunner.expect(authManager.isAuthenticated()).toBeTruthy();
                });

                await testRunner.it('should manage focus during ticket operations', async () => {
                    const authManager = new AuthManager();
                    await authManager.login({ username: 'demo', password: 'password' });
                    
                    const ticketManager = new TicketManager();
                    
                    // Test focus during ticket creation
                    const result = await ticketManager.createTicket({
                        title: 'Focus Test Ticket',
                        description: 'Testing focus management',
                        status: 'Open'
                    });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.ticket).toBeTruthy();
                });

                await testRunner.it('should handle focus trapping in modals', async () => {
                    // Test that focus is properly managed in modal-like interactions
                    const ticketManager = new TicketManager();
                    
                    const tickets = ticketManager.getTickets();
                    testRunner.expect(Array.isArray(tickets)).toBeTruthy();
                    
                    // Focus should be contained within the active context
                    testRunner.expect(ticketManager).toBeTruthy();
                });

                await testRunner.it('should restore focus after operations', async () => {
                    const authManager = new AuthManager();
                    const ticketManager = new TicketManager();
                    
                    // Login
                    await authManager.login({ username: 'demo', password: 'password' });
                    
                    // Create ticket
                    await ticketManager.createTicket({
                        title: 'Focus Restore Test',
                        description: 'Testing focus restoration',
                        status: 'Open'
                    });
                    
                    // Focus should be restored appropriately
                    testRunner.expect(authManager.isAuthenticated()).toBeTruthy();
                    testRunner.expect(ticketManager.getTickets().length).toBeGreaterThan(0);
                });
            });

            document.getElementById('focus-test-btn').disabled = false;
        }

        // ARIA Support Tests
        async function runAriaTests() {
            testRunner.clearResults('aria-support');
            document.getElementById('aria-test-btn').disabled = true;
            
            await testRunner.describe('ARIA Support', async () => {
                setupTestEnvironment();

                await testRunner.it('should provide ARIA-compliant status updates', async () => {
                    const authManager = new AuthManager();
                    
                    // Test login status updates
                    const result = await authManager.login({ username: 'demo', password: 'password' });
                    testRunner.expect(result.success).toBeTruthy();
                    
                    // Should provide status information
                    testRunner.expect(authManager.isAuthenticated()).toBeTruthy();
                });

                await testRunner.it('should provide ARIA labels for form elements', async () => {
                    const ticketManager = new TicketManager();
                    
                    // Test that form data is properly structured
                    const result = await ticketManager.createTicket({
                        title: 'ARIA Test Ticket',
                        description: 'Testing ARIA compliance',
                        status: 'Open'
                    });
                    
                    testRunner.expect(result.success).toBeTruthy();
                    testRunner.expect(result.ticket.title).toBe('ARIA Test Ticket');
                });

                await testRunner.it('should provide ARIA live regions for dynamic content', async () => {
                    const ticketManager = new TicketManager();
                    
                    // Create ticket (dynamic content update)
                    const createResult = await ticketManager.createTicket({
                        title: 'Live Region Test',
                        description: 'Testing live regions',
                        status: 'Open'
                    });
                    
                    testRunner.expect(createResult.success).toBeTruthy();
                    
                    // Update ticket (another dynamic update)
                    const updateResult = await ticketManager.updateTicket(createResult.ticket.id, {
                        title: 'Updated Live Region Test',
                        status: 'In Progress'
                    });
                    
                    testRunner.expect(updateResult.success).toBeTruthy();
                });

                await testRunner.it('should provide ARIA descriptions for complex interactions', async () => {
                    const authManager = new AuthManager();
                    const ticketManager = new TicketManager();
                    
                    // Complex interaction: login + create + update + delete
                    await authManager.login({ username: 'admin', password: 'admin123' });
                    
                    const createResult = await ticketManager.createTicket({
                        title: 'Complex Interaction Test',
                        description: 'Testing complex ARIA interactions',
                        status: 'Open'
                    });
                    
                    const updateResult = await ticketManager.updateTicket(createResult.ticket.id, {
                        status: 'Closed'
                    });
                    
                    const deleteResult = await ticketManager.deleteTicket(createResult.ticket.id, true);
                    
                    testRunner.expect(createResult.success).toBeTruthy();
                    testRunner.expect(updateResult.success).toBeTruthy();
                    testRunner.expect(deleteResult.success).toBeTruthy();
                });
            });

            document.getElementById('aria-test-btn').disabled = false;
        }

        // Run all accessibility tests
        async function runAllAccessibilityTests() {
            console.log('Starting complete accessibility test suite...');
            
            await runKeyboardTests();
            await testRunner.delay(500);
            
            await runScreenReaderTests();
            await testRunner.delay(500);
            
            await runHighContrastTests();
            await testRunner.delay(500);
            
            await runFocusTests();
            await testRunner.delay(500);
            
            await runAriaTests();
            
            console.log('Complete accessibility test suite finished!');
            
            // Show summary
            const totalTests = testRunner.totalTests;
            const passedTests = testRunner.passedTests;
            const failedTests = testRunner.failedTests;
            const successRate = ((passedTests / totalTests) * 100).toFixed(1);
            
            console.log(`\nAccessibility Test Summary:`);
            console.log(`Total Tests: ${totalTests}`);
            console.log(`Passed: ${passedTests}`);
            console.log(`Failed: ${failedTests}`);
            console.log(`Success Rate: ${successRate}%`);
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            setupTestEnvironment();
            console.log('Accessibility E2E Test Suite Ready');
            
            // Add run all tests button
            const runAllBtn = document.createElement('button');
            runAllBtn.textContent = 'Run All Accessibility Tests';
            runAllBtn.onclick = runAllAccessibilityTests;
            runAllBtn.style.cssText = 'background: #28a745; font-size: 1.1em; padding: 0.75rem 1.5rem; margin: 1rem 0;';
            document.body.insertBefore(runAllBtn, document.querySelector('.test-section'));
        });
    </script>
</body>
</html>