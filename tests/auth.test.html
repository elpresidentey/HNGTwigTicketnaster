<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Module Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-suite { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
        .test-case { margin: 10px 0; padding: 8px; border-left: 3px solid #ccc; }
        .test-pass { border-left-color: #4CAF50; background-color: #f1f8e9; }
        .test-fail { border-left-color: #f44336; background-color: #ffebee; }
        .test-summary { font-weight: bold; margin-top: 20px; padding: 10px; }
        .pass { color: #4CAF50; }
        .fail { color: #f44336; }
        pre { background: #f5f5f5; padding: 10px; margin: 5px 0; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Authentication Module Unit Tests</h1>
    <div id="test-results"></div>
    <div id="test-summary"></div>

    <!-- Load the authentication module -->
    <script src="../public/assets/js/auth.js"></script>
    
    <script>
        // Simple test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
                this.currentSuite = '';
            }

            describe(suiteName, testFn) {
                this.currentSuite = suiteName;
                console.log(`\n=== ${suiteName} ===`);
                testFn();
            }

            it(testName, testFn) {
                try {
                    testFn();
                    this.results.push({ suite: this.currentSuite, name: testName, status: 'pass' });
                    console.log(`✓ ${testName}`);
                } catch (error) {
                    this.results.push({ 
                        suite: this.currentSuite, 
                        name: testName, 
                        status: 'fail', 
                        error: error.message 
                    });
                    console.error(`✗ ${testName}: ${error.message}`);
                }
            }

            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual !== expected) {
                            throw new Error(`Expected ${expected}, but got ${actual}`);
                        }
                    },
                    toEqual: (expected) => {
                        if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                            throw new Error(`Expected ${JSON.stringify(expected)}, but got ${JSON.stringify(actual)}`);
                        }
                    },
                    toBeTruthy: () => {
                        if (!actual) {
                            throw new Error(`Expected truthy value, but got ${actual}`);
                        }
                    },
                    toBeFalsy: () => {
                        if (actual) {
                            throw new Error(`Expected falsy value, but got ${actual}`);
                        }
                    },
                    toContain: (expected) => {
                        if (typeof actual === 'string' && !actual.includes(expected)) {
                            throw new Error(`Expected "${actual}" to contain "${expected}"`);
                        }
                        if (Array.isArray(actual) && !actual.includes(expected)) {
                            throw new Error(`Expected array to contain ${expected}`);
                        }
                    },
                    toThrow: () => {
                        let threw = false;
                        try {
                            if (typeof actual === 'function') {
                                actual();
                            }
                        } catch (e) {
                            threw = true;
                        }
                        if (!threw) {
                            throw new Error('Expected function to throw an error');
                        }
                    }
                };
            }

            renderResults() {
                const resultsDiv = document.getElementById('test-results');
                const summaryDiv = document.getElementById('test-summary');
                
                let html = '';
                let currentSuite = '';
                
                this.results.forEach(result => {
                    if (result.suite !== currentSuite) {
                        if (currentSuite !== '') html += '</div>';
                        html += `<div class="test-suite"><h3>${result.suite}</h3>`;
                        currentSuite = result.suite;
                    }
                    
                    const statusClass = result.status === 'pass' ? 'test-pass' : 'test-fail';
                    const statusIcon = result.status === 'pass' ? '✓' : '✗';
                    
                    html += `<div class="test-case ${statusClass}">
                        ${statusIcon} ${result.name}
                        ${result.error ? `<pre>Error: ${result.error}</pre>` : ''}
                    </div>`;
                });
                
                if (currentSuite !== '') html += '</div>';
                resultsDiv.innerHTML = html;
                
                // Summary
                const passed = this.results.filter(r => r.status === 'pass').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                const total = this.results.length;
                
                summaryDiv.innerHTML = `
                    <div class="test-summary">
                        Tests: ${total} | 
                        <span class="pass">Passed: ${passed}</span> | 
                        <span class="fail">Failed: ${failed}</span>
                    </div>
                `;
            }
        }

        // Mock localStorage for testing
        class MockLocalStorage {
            constructor() {
                this.store = {};
            }

            getItem(key) {
                return this.store[key] || null;
            }

            setItem(key, value) {
                this.store[key] = String(value);
            }

            removeItem(key) {
                delete this.store[key];
            }

            clear() {
                this.store = {};
            }

            get length() {
                return Object.keys(this.store).length;
            }

            key(index) {
                const keys = Object.keys(this.store);
                return keys[index] || null;
            }
        }

        // Mock sessionStorage for testing
        class MockSessionStorage {
            constructor() {
                this.store = {};
            }

            getItem(key) {
                return this.store[key] || null;
            }

            setItem(key, value) {
                this.store[key] = String(value);
            }

            removeItem(key) {
                delete this.store[key];
            }

            clear() {
                this.store = {};
            }
        }

        // Initialize test runner
        const testRunner = new TestRunner();
        const { describe, it, expect } = testRunner;

        // Store original localStorage and sessionStorage
        const originalLocalStorage = window.localStorage;
        const originalSessionStorage = window.sessionStorage;

        // Run tests
        describe('AuthManager - Login Functionality', () => {
            let authManager;
            let mockLocalStorage;

            // Setup before each test
            function setup() {
                mockLocalStorage = new MockLocalStorage();
                window.localStorage = mockLocalStorage;
                authManager = new AuthManager();
            }

            it('should successfully login with valid credentials', async () => {
                setup();
                const credentials = { username: 'demo', password: 'password' };
                
                const result = await authManager.login(credentials);
                
                expect(result.success).toBe(true);
                expect(result.user.username).toBe('demo');
                expect(result.message).toBe('Login successful');
            });

            it('should store session token in localStorage on successful login', async () => {
                setup();
                const credentials = { username: 'admin', password: 'admin123' };
                
                await authManager.login(credentials);
                
                const sessionData = mockLocalStorage.getItem('ticketapp_session');
                expect(sessionData).toBeTruthy();
                
                const session = JSON.parse(sessionData);
                expect(session.token).toBeTruthy();
                expect(session.user.username).toBe('admin');
                expect(session.expiresAt).toBeTruthy();
            });

            it('should fail login with invalid credentials', async () => {
                setup();
                const credentials = { username: 'invalid', password: 'wrong' };
                
                const result = await authManager.login(credentials);
                
                expect(result.success).toBe(false);
                expect(result.error).toContain('Invalid username or password');
            });

            it('should fail login with missing credentials', async () => {
                setup();
                
                const result1 = await authManager.login({});
                expect(result1.success).toBe(false);
                expect(result1.error).toContain('Username and password are required');
                
                const result2 = await authManager.login({ username: 'test' });
                expect(result2.success).toBe(false);
                expect(result2.error).toContain('Username and password are required');
            });

            it('should accept email addresses as usernames', async () => {
                setup();
                const credentials = { username: 'test@example.com', password: 'password123' };
                
                const result = await authManager.login(credentials);
                
                expect(result.success).toBe(true);
                expect(result.user.email).toBe('test@example.com');
            });
        });

        describe('AuthManager - Logout Functionality', () => {
            let authManager;
            let mockLocalStorage;

            function setup() {
                mockLocalStorage = new MockLocalStorage();
                window.localStorage = mockLocalStorage;
                authManager = new AuthManager();
            }

            it('should successfully logout and clear session data', () => {
                setup();
                
                // Set up a session first
                const sessionData = {
                    token: 'test-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: Date.now() + 86400000
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                mockLocalStorage.setItem('user_preferences', 'some-data');
                
                const result = authManager.logout();
                
                expect(result.success).toBe(true);
                expect(result.message).toBe('Logged out successfully');
                expect(mockLocalStorage.getItem('ticketapp_session')).toBe(null);
                expect(mockLocalStorage.getItem('user_preferences')).toBe(null);
            });

            it('should handle logout when no session exists', () => {
                setup();
                
                const result = authManager.logout();
                
                expect(result.success).toBe(true);
                expect(result.message).toBe('Logged out successfully');
            });
        });

        describe('AuthManager - Session Validation', () => {
            let authManager;
            let mockLocalStorage;

            function setup() {
                mockLocalStorage = new MockLocalStorage();
                window.localStorage = mockLocalStorage;
                authManager = new AuthManager();
            }

            it('should return true for valid, non-expired session', () => {
                setup();
                
                const sessionData = {
                    token: 'valid-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: Date.now() + 86400000 // 24 hours from now
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                
                expect(authManager.isAuthenticated()).toBe(true);
            });

            it('should return false when no session exists', () => {
                setup();
                
                expect(authManager.isAuthenticated()).toBe(false);
            });

            it('should return false and cleanup expired session', () => {
                setup();
                
                const expiredSessionData = {
                    token: 'expired-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: Date.now() - 1000 // 1 second ago
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(expiredSessionData));
                
                expect(authManager.isAuthenticated()).toBe(false);
                expect(mockLocalStorage.getItem('ticketapp_session')).toBe(null);
            });

            it('should return false for malformed session data', () => {
                setup();
                
                mockLocalStorage.setItem('ticketapp_session', 'invalid-json');
                
                expect(authManager.isAuthenticated()).toBe(false);
                expect(mockLocalStorage.getItem('ticketapp_session')).toBe(null);
            });

            it('should return false for session missing required properties', () => {
                setup();
                
                const incompleteSession = {
                    token: 'test-token'
                    // missing user and expiresAt
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(incompleteSession));
                
                expect(authManager.isAuthenticated()).toBe(false);
            });
        });

        describe('AuthManager - Session Management', () => {
            let authManager;
            let mockLocalStorage;

            function setup() {
                mockLocalStorage = new MockLocalStorage();
                window.localStorage = mockLocalStorage;
                authManager = new AuthManager();
            }

            it('should return session data when authenticated', () => {
                setup();
                
                const sessionData = {
                    token: 'test-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: Date.now() + 86400000
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                
                const session = authManager.getSession();
                expect(session).toBeTruthy();
                expect(session.user.username).toBe('test');
            });

            it('should return null when not authenticated', () => {
                setup();
                
                const session = authManager.getSession();
                expect(session).toBe(null);
            });

            it('should return current user data', () => {
                setup();
                
                const sessionData = {
                    token: 'test-token',
                    user: { id: '1', username: 'testuser', email: 'test@example.com' },
                    expiresAt: Date.now() + 86400000
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                
                const user = authManager.getCurrentUser();
                expect(user).toBeTruthy();
                expect(user.username).toBe('testuser');
                expect(user.email).toBe('test@example.com');
            });

            it('should refresh session expiration time', () => {
                setup();
                
                const originalExpiry = Date.now() + 3600000; // 1 hour
                const sessionData = {
                    token: 'test-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: originalExpiry
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                
                const result = authManager.refreshSession();
                expect(result).toBe(true);
                
                const updatedSession = JSON.parse(mockLocalStorage.getItem('ticketapp_session'));
                expect(updatedSession.expiresAt).toBeGreaterThan(originalExpiry);
            });
        });

        describe('AuthManager - Route Protection', () => {
            let authManager;
            let mockLocalStorage;
            let mockSessionStorage;
            let originalLocation;

            function setup() {
                mockLocalStorage = new MockLocalStorage();
                mockSessionStorage = new MockSessionStorage();
                window.localStorage = mockLocalStorage;
                window.sessionStorage = mockSessionStorage;
                authManager = new AuthManager();
                
                // Mock window.location
                originalLocation = window.location;
                delete window.location;
                window.location = { href: '' };
            }

            function teardown() {
                window.location = originalLocation;
            }

            it('should redirect to login when not authenticated', () => {
                setup();
                
                const redirected = authManager.redirectIfNotAuth();
                
                expect(redirected).toBe(true);
                expect(window.location.href).toBe('/auth/login');
                
                teardown();
            });

            it('should not redirect when authenticated', () => {
                setup();
                
                const sessionData = {
                    token: 'test-token',
                    user: { id: '1', username: 'test' },
                    expiresAt: Date.now() + 86400000
                };
                mockLocalStorage.setItem('ticketapp_session', JSON.stringify(sessionData));
                
                const redirected = authManager.redirectIfNotAuth();
                
                expect(redirected).toBe(false);
                expect(window.location.href).toBe('');
                
                teardown();
            });

            it('should store redirect URL and message', () => {
                setup();
                
                authManager.redirectIfNotAuth('/dashboard', 'Please log in to continue');
                
                expect(mockSessionStorage.getItem('auth_redirect')).toBe('/dashboard');
                expect(mockSessionStorage.getItem('auth_message')).toBe('Please log in to continue');
                
                teardown();
            });
        });

        describe('AuthManager - Error Handling', () => {
            let authManager;
            let mockLocalStorage;

            function setup() {
                mockLocalStorage = new MockLocalStorage();
                window.localStorage = mockLocalStorage;
                authManager = new AuthManager();
            }

            it('should handle localStorage errors gracefully', () => {
                setup();
                
                // Mock localStorage to throw error
                mockLocalStorage.setItem = () => {
                    throw new Error('Storage quota exceeded');
                };
                
                // This should not throw an error
                expect(() => authManager.isAuthenticated()).not.toThrow();
            });

            it('should validate credential format', async () => {
                setup();
                
                const shortUsername = { username: 'ab', password: 'password' };
                const result1 = await authManager.login(shortUsername);
                expect(result1.success).toBe(false);
                
                const shortPassword = { username: 'validuser', password: '12345' };
                const result2 = await authManager.login(shortPassword);
                expect(result2.success).toBe(false);
            });

            it('should handle malformed JSON in localStorage', () => {
                setup();
                
                mockLocalStorage.setItem('ticketapp_session', '{invalid json}');
                
                expect(authManager.isAuthenticated()).toBe(false);
                expect(mockLocalStorage.getItem('ticketapp_session')).toBe(null);
            });
        });

        // Restore original localStorage and sessionStorage
        window.localStorage = originalLocalStorage;
        window.sessionStorage = originalSessionStorage;

        // Render test results
        testRunner.renderResults();
    </script>
</body>
</html>